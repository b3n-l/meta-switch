From 6ef0ce2ee6f12a42ae13a9aff3debc28fb1755f5 Mon Sep 17 00:00:00 2001
From: Rubens Figueiredo <rubens.figueiredo@bisdn.de>
Date: Fri, 20 Mar 2020 16:09:36 +0100
Subject: [PATCH] v245 backport: add vlan protocol parameter for bridges

---
 man/systemd.netdev.xml                        |  9 ++++++
 src/network/netdev/bridge.c                   |  7 ++++
 src/network/netdev/bridge.h                   |  1 +
 src/network/netdev/netdev-gperf.gperf         |  1 +
 src/shared/conf-parser.c                      | 32 +++++++++++++++++++
 src/shared/conf-parser.h                      |  1 +
 .../fuzz/fuzz-netdev-parser/directives.netdev |  1 +
 7 files changed, 52 insertions(+)

diff --git a/man/systemd.netdev.xml b/man/systemd.netdev.xml
index 74281f2d0b..31c6e78f51 100644
--- a/man/systemd.netdev.xml
+++ b/man/systemd.netdev.xml
@@ -393,6 +393,15 @@
             </para>
           </listitem>
         </varlistentry>
+      <varlistentry>
+        <term><varname>VLANProtocol=</varname></term>
+        <listitem>
+          <para>Allows setting the protocol used for VLAN filtering. Takes
+          <option>802.1Q</option> or,
+          <option>802.1AD</option>, and defaults to unset and kernel's default is used.
+          </para>
+        </listitem>
+      </varlistentry>
           <varlistentry>
           <term><varname>STP=</varname></term>
           <listitem>
diff --git a/src/network/netdev/bridge.c b/src/network/netdev/bridge.c
index aadb3ab905..7095a42bd0 100644
--- a/src/network/netdev/bridge.c
+++ b/src/network/netdev/bridge.c
@@ -114,6 +114,12 @@ static int netdev_bridge_post_create(NetDev *netdev, Link *link, sd_netlink_mess
                         return log_netdev_error_errno(netdev, r, "Could not append IFLA_BR_VLAN_FILTERING attribute: %m");
         }
 
+        if (b->vlan_protocol >= 0) {
+                r = sd_netlink_message_append_u16(req, IFLA_BR_VLAN_PROTOCOL, b->vlan_protocol);
+                if (r < 0)
+                        return log_netdev_error_errno(netdev, r, "Could not append IFLA_BR_VLAN_PROTOCOL attribute: %m");
+        }
+
         if (b->stp >= 0) {
                 r = sd_netlink_message_append_u32(req, IFLA_BR_STP_STATE, b->stp);
                 if (r < 0)
@@ -148,6 +154,7 @@ static void bridge_init(NetDev *n) {
         b->mcast_querier = -1;
         b->mcast_snooping = -1;
         b->vlan_filtering = -1;
+        b->vlan_protocol = -1;
         b->stp = -1;
         b->default_pvid = VLANID_INVALID;
         b->forward_delay = USEC_INFINITY;
diff --git a/src/network/netdev/bridge.h b/src/network/netdev/bridge.h
index 3edc93a767..fb461b5cc4 100644
--- a/src/network/netdev/bridge.h
+++ b/src/network/netdev/bridge.h
@@ -9,6 +9,7 @@ typedef struct Bridge {
         int mcast_querier;
         int mcast_snooping;
         int vlan_filtering;
+        int vlan_protocol;
         int stp;
         uint16_t priority;
         uint16_t group_fwd_mask;
diff --git a/src/network/netdev/netdev-gperf.gperf b/src/network/netdev/netdev-gperf.gperf
index f7ca98fa46..1aa0e9aabc 100644
--- a/src/network/netdev/netdev-gperf.gperf
+++ b/src/network/netdev/netdev-gperf.gperf
@@ -161,6 +161,7 @@ Bridge.DefaultPVID,                config_parse_default_port_vlanid,     0,
 Bridge.MulticastQuerier,           config_parse_tristate,                0,                             offsetof(Bridge, mcast_querier)
 Bridge.MulticastSnooping,          config_parse_tristate,                0,                             offsetof(Bridge, mcast_snooping)
 Bridge.VLANFiltering,              config_parse_tristate,                0,                             offsetof(Bridge, vlan_filtering)
+Bridge.VLANProtocol,               config_parse_vlanprotocol,            0,                             offsetof(Bridge, vlan_protocol)
 Bridge.STP,                        config_parse_tristate,                0,                             offsetof(Bridge, stp)
 VRF.TableId,                       config_parse_uint32,                  0,                             offsetof(Vrf, table) /* deprecated */
 VRF.Table,                         config_parse_uint32,                  0,                             offsetof(Vrf, table)
diff --git a/src/shared/conf-parser.c b/src/shared/conf-parser.c
index b80c147807..969d9552af 100644
--- a/src/shared/conf-parser.c
+++ b/src/shared/conf-parser.c
@@ -1111,3 +1111,35 @@ int config_parse_permille(const char* unit,
 
         return 0;
 }
+
+int config_parse_vlanprotocol(const char* unit,
+                              const char *filename,
+                              unsigned line,
+                              const char *section,
+                              unsigned section_line,
+                              const char *lvalue,
+                              int ltype,
+                              const char *rvalue,
+                              void *data,
+                              void *userdata) {
+        int *vlanprotocol = data;
+        assert(filename);
+        assert(lvalue);
+
+        if (isempty(rvalue)) {
+                *vlanprotocol = -1;
+                return 0;
+        }
+
+        if (STR_IN_SET(rvalue, "802.1ad", "802.1AD"))
+                *vlanprotocol = htons(ETH_P_8021AD);
+        else if (STR_IN_SET(rvalue, "802.1q", "802.1Q"))
+                *vlanprotocol = htons(ETH_P_8021Q);
+        else {
+                log_syntax(unit, LOG_ERR, filename, line, 0,
+                           "Failed to parse VLAN protocol value, ignoring: %s", rvalue);
+                return 0;
+        }
+
+        return 0;
+}
diff --git a/src/shared/conf-parser.h b/src/shared/conf-parser.h
index 865db4278b..fdfc6a7ccc 100644
--- a/src/shared/conf-parser.h
+++ b/src/shared/conf-parser.h
@@ -139,6 +139,7 @@ CONFIG_PARSER_PROTOTYPE(config_parse_ifname);
 CONFIG_PARSER_PROTOTYPE(config_parse_ip_port);
 CONFIG_PARSER_PROTOTYPE(config_parse_mtu);
 CONFIG_PARSER_PROTOTYPE(config_parse_rlimit);
+CONFIG_PARSER_PROTOTYPE(config_parse_vlanprotocol);
 
 typedef enum Disabled {
         DISABLED_CONFIGURATION,
diff --git a/test/fuzz/fuzz-netdev-parser/directives.netdev b/test/fuzz/fuzz-netdev-parser/directives.netdev
index cd7c3aaded..aa26e7dacd 100644
--- a/test/fuzz/fuzz-netdev-parser/directives.netdev
+++ b/test/fuzz/fuzz-netdev-parser/directives.netdev
@@ -42,6 +42,7 @@ AgeingTimeSec=
 Priority=
 GroupForwardMask=
 VLANFiltering=
+VLANProtocol=
 [VRF]
 TableId=
 Table=
-- 
2.21.1

