From 9f4783521efb9a83f1175ef0c44c38e1ba1ca8c7 Mon Sep 17 00:00:00 2001
From: Yu Watanabe <watanabe.yu+github@gmail.com>
Date: Mon, 16 Sep 2019 06:07:38 +0900
Subject: [PATCH] network: drop IPv6LL address when LinkLocalAddressing=no|ipv4

C.f. disscussion in #13533.

Hopefully fixes #12886.

---
 src/network/networkd-link.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/src/network/networkd-link.c b/src/network/networkd-link.c
index 792862e6a5..d3eface5ba 100644
--- a/src/network/networkd-link.c
+++ b/src/network/networkd-link.c
@@ -2714,7 +2714,7 @@ static int link_drop_foreign_config(Link *link) {
 
         SET_FOREACH(address, link->addresses_foreign, i) {
                 /* we consider IPv6LL addresses to be managed by the kernel */
-                if (address->family == AF_INET6 && in_addr_is_link_local(AF_INET6, &address->in_addr) == 1)
+                if (address->family == AF_INET6 && in_addr_is_link_local(AF_INET6, &address->in_addr) == 1 && link_ipv6ll_enabled(link))
                         continue;
 
                 if (link_is_static_address_configured(link, address)) {
@@ -2755,7 +2755,7 @@ static int link_drop_config(Link *link) {
 
         SET_FOREACH(address, link->addresses, i) {
                 /* we consider IPv6LL addresses to be managed by the kernel */
-                if (address->family == AF_INET6 && in_addr_is_link_local(AF_INET6, &address->in_addr) == 1)
+                if (address->family == AF_INET6 && in_addr_is_link_local(AF_INET6, &address->in_addr) == 1 && link_ipv6ll_enabled(link))
                         continue;
 
                 r = address_remove(address, link, NULL);

